---
title: "BCellStatistics Cell Type Level 0"
output: html_document
date: "2024-12-19"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
library(Seurat)
library(dplyr)
library(ggplot2)
library(tidyverse)
```

```{r include=FALSE}
data = readRDS("./TMA_unfiltered_annotated_full_final.rds")

```
```{r include=FALSE}
metadata <- data@meta.data
```

```{r include=FALSE}
metadata <- metadata %>%
  mutate(lowQ = ifelse(cell_type_level0 == "low_qual", TRUE, FALSE))

lowq_counts <- metadata %>%
  group_by(orig.ident, tumor_core) %>%
  summarise(lowq_cell_count = sum(lowQ, na.rm = TRUE)) 

metadata <- metadata %>%
  mutate(
    is_b_cell_lineage = case_when(
      cell_type_level0 %in% c("B") ~ TRUE, # was B cell and Plasmablast before
      TRUE ~ FALSE
    )
  )

b_cell_counts <- metadata %>%
  group_by(orig.ident, tumor_core) %>%
  summarise(
    b_cell_lineage_count = sum(is_b_cell_lineage, na.rm = TRUE),
    total_cells = n(),
    b_cell_lineage_percentage = sum(is_b_cell_lineage, na.rm = TRUE) / total_cells * 100
  )

b_cell_counts <- b_cell_counts %>%
  left_join(lowq_counts, by = c("orig.ident", "tumor_core"))

b_cell_counts <- b_cell_counts %>%
  mutate(
    lowq_percentage = (lowq_cell_count / total_cells) * 100,
    unclassified_percentage = (metadata %>%
      filter(cell_type_level0 == "unclassified") %>%
      group_by(orig.ident, tumor_core) %>%
      summarise(unclassified_count = n()) %>%
      .$unclassified_count / total_cells) * 100,
    sum_percentage = lowq_percentage + unclassified_percentage
  )


```

```{r include=FALSE}
plot_data <- b_cell_counts %>%
  select(orig.ident, lowq_percentage, unclassified_percentage, sum_percentage) %>%
  pivot_longer(
    cols = c(lowq_percentage, unclassified_percentage, sum_percentage),
    names_to = "metric",
    values_to = "percentage"
  )

```


```{r include=FALSE}
# Create density plots for each metric for each TMA
unique_metrics <- unique(plot_data$metric)

for (metric in unique_metrics) {
  metric_data <- plot_data %>%
    filter(metric == !!metric) #
  
  plot <- ggplot(metric_data, aes(x = percentage, color = orig.ident)) +
    geom_density(alpha = 0.6, size = 1) +
    labs(
      title = paste("Density of", gsub("_", " ", metric), "Across TMAs"),
      x = "Percentage per Core",
      y = "Density",
      color = "TMA"
    ) +
    theme_minimal(base_size = 14) +
    scale_color_brewer(palette = "Set1") +
    theme(
      legend.position = "top",
      plot.title = element_text(face = "bold")
    )
  
  print (plot)
}


```

# Density Plots for B Cell Counts and Percentages
```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(b_cell_counts, aes(x = b_cell_lineage_count, fill = orig.ident)) +
  geom_density(alpha = 0.6) +
  facet_wrap(~ orig.ident, ncol = 1) +
  labs(
    title = "Density of B-cell Counts Across TMAs",
    x = "B-cell Count per Core",
    y = "Density",
    fill = "TMA"
  ) +
  theme_minimal(base_size = 14) +
  scale_fill_brewer(palette = "Set2") +
  theme(
    legend.position = "top",
    strip.text = element_text(face = "bold")
  )

ggplot(b_cell_counts, aes(x = b_cell_lineage_count, fill = orig.ident)) +
  geom_density(alpha = 0.6) +
  facet_wrap(~ orig.ident, ncol = 1) +
  labs(
    title = "Density of B-cell Counts Across TMAs (Log10)",
    x = "B-cell Count per Core",
    y = "Density",
    fill = "TMA"
  ) +
  theme_minimal(base_size = 14) +
  scale_fill_brewer(palette = "Set2") +
  theme(
    legend.position = "top",
    strip.text = element_text(face = "bold")
  ) + 
  scale_x_log10()

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(b_cell_counts, aes(x = b_cell_lineage_percentage, fill = orig.ident)) +
  geom_density(alpha = 0.6) +
  facet_wrap(~ orig.ident, ncol = 1) +
  labs(
    title = "Density of B-cell Percentages Across TMAs",
    x = "Percentage of B-cell Cells per Core",
    y = "Density",
    fill = "TMA"
  ) +
  theme_minimal(base_size = 14) +
  scale_fill_brewer(palette = "Set2") +
  theme(
    legend.position = "top",
    strip.text = element_text(face = "bold")
  ) 

ggplot(b_cell_counts, aes(x = b_cell_lineage_percentage, fill = orig.ident)) +
  geom_density(alpha = 0.6) +
  facet_wrap(~ orig.ident, ncol = 1) +
  labs(
    title = "Density of B-cell Percentages Across TMAs (Log10)",
    x = "Percentage of B-cell Cells per Core",
    y = "Density",
    fill = "TMA"
  ) +
  theme_minimal(base_size = 14) +
  scale_fill_brewer(palette = "Set2") +
  theme(
    legend.position = "top",
    strip.text = element_text(face = "bold")
  ) + 
  scale_x_log10()

```




# B lineage percentage Barplots 
```{r include=FALSE}
combined_annotation = read.csv("./final_core_annotation.csv")
```

```{r include=FALSE}
b_cell_counts_parsed <- b_cell_counts %>%
  mutate(TMA = orig.ident) %>%
  mutate(MappedCore = str_remove(tumor_core, "^TMA[0-9]_"))


b_cell_counts_parsed <- b_cell_counts_parsed %>%
  left_join(
    combined_annotation, 
    by = c("TMA", "MappedCore")
  )

```


```{r message=FALSE, warning=FALSE, include=FALSE}
b_cell_counts_parsed %>%
  group_split(orig.ident) %>%
  purrr::walk(function(tma_data) {
    tma_name <- unique(tma_data$orig.ident)
    
    tma_data <- tma_data %>%
      mutate(tumor_core_clean = str_remove(tumor_core, "TMA[0-9]_"))
    
    tma_data <- tma_data %>%
      arrange(b_cell_lineage_percentage)
    
    plot <- ggplot(
      tma_data, 
      aes(
        x = reorder(tumor_core_clean, b_cell_lineage_percentage),
        y = b_cell_lineage_percentage,
        fill = tissue     
      )
    ) +
      geom_bar(stat = "identity") +
      labs(
        title = paste("B Cell Lineage Percentage -", tma_name),
        x = "Tumor Core",
        y = "B Cell Lineage Percentage"
      ) +
      theme_minimal(base_family = "sans") +
      theme(
        axis.text.x = element_text(angle = 45, hjust = 1),
        plot.background = element_rect(fill = "white", color = "white"),
        plot.title = element_text(size = 14, face = "bold")
      )
    
    print(plot)
    
    ggsave(
      filename = paste0("b_cell_lineage_", tma_name, ".png"),
      plot = plot,
      bg = "white", 
      width = 10,
      height = 6
    )
  })
```


# MCPCounter Scatter Plots

```{r include=FALSE}
annotation_tma1 = read.csv("./Rmd/merscope_annotTMA1.txt", sep = "\t")
annotation_tma2 = read.csv("./Rmd/merscope_annotTMA2.txt", sep = "\t")
annotation_tma3 = read.csv("./Rmd/merscope_annotTMA3.txt", sep = "\t")

```


```{r message=FALSE, warning=FALSE, include=FALSE}
metadata$mcpCounterBcell <- 0

counts <- GetAssayData(data, slot = "counts")

metadata$tma_core <- paste(metadata$orig.ident, metadata$tumor_core, sep = "_")

for (core in unique(metadata$tma_core)) {
  core_cells <- rownames(metadata[metadata$tma_core == core, ])
  core_counts <- counts[, core_cells, drop = FALSE]
  
  if (ncol(core_counts) > 0) {
    mcp_results <- immunedeconv::deconvolute_mcp_counter(core_counts)
    metadata$mcpCounterBcell[rownames(metadata) %in% core_cells] <- as.numeric(mcp_results["B lineage", ])
  }
}

mcp_summary <- metadata %>%
  group_by(orig.ident, tumor_core) %>%
  summarise(mean_mcp_bcell_score = mean(mcpCounterBcell, na.rm = TRUE))

b_cell_counts <- b_cell_counts %>%
  left_join(mcp_summary, by = c("orig.ident", "tumor_core"))

```

```{r include=FALSE}
annotation_tma2 <- annotation_tma2 %>%
  mutate(
    ID = gsub("_2nd_", "_", ID),
    pair = gsub("_2nd_", "_", pair)
  )

annotation_combined <- bind_rows(
  annotation_tma1 %>% select(ID, pair, tissue, IHC_class, excluded),
  annotation_tma2 %>% select(ID, pair, tissue, IHC_class, excluded),
  annotation_tma3 %>% select(ID, pair, tissue, IHC_class, excluded)
) %>%
  pivot_longer(cols = c(ID, pair), names_to = "type", values_to = "tma_core") %>%
  select(-type) %>%
  distinct(tma_core, .keep_all = TRUE) 


b_cell_counts <- b_cell_counts %>%
  left_join(annotation_combined, by = c("tumor_core" = "tma_core"))

print(b_cell_counts)

```




```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(b_cell_counts, aes(x = mean_mcp_bcell_score, y = b_cell_lineage_count, color = orig.ident)) +
  geom_point(aes(shape = tissue), alpha = 0.6, size = 3) +
  labs(
    title = "MCP-counter B-cell Score vs. B-cell Count",
    x = "Mean MCP-counter B-cell Score",
    y = "B-cell Count",
    color = "TMA",
    shape = "Tissue"
  ) +
  theme_minimal(base_size = 14) +
  scale_color_brewer(palette = "Set2") + 
  scale_shape_manual(values = c(15, 16, 17, 18, 19)) + 
  scale_x_log10() + 
  scale_y_log10()


```

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(b_cell_counts, aes(x = mean_mcp_bcell_score, y = b_cell_lineage_percentage, color = orig.ident)) +
  geom_point(aes(shape = tissue), alpha = 0.6, size = 3) +
  labs(
    title = "MCP-counter B-cell Score vs. B-cell Percentage",
    x = "Mean MCP-counter B-cell Score",
    y = "B-cell Percentage",
    color = "TMA",
    shape = "Tissue"
  ) +
  theme_minimal(base_size = 14) +
  scale_color_brewer(palette = "Set2") +
  scale_shape_manual(values = c(15, 16, 17, 18, 19)) + 
  scale_x_log10() + 
  scale_y_log10()

```

# Diagnostic Plots regarding LowQ Abundance

```{r echo=FALSE, message=FALSE, warning=FALSE}

diagnostic_data <- metadata %>%
  group_by(orig.ident, tumor_core, lowQ) %>%
  summarise(cell_count = n()) %>%
  group_by(orig.ident, tumor_core) %>%
  mutate(percentage = cell_count / sum(cell_count) * 100) %>%
  ungroup()


diagnostic_data <- diagnostic_data %>%
  mutate(core_id = sub(".*_", "", tumor_core)) 

unique_tmas <- unique(diagnostic_data$orig.ident)

for (tma in unique_tmas) {
  tma_data <- diagnostic_data %>%
    filter(orig.ident == tma)
  
  plot <- ggplot(tma_data, aes(x = core_id, y = percentage, fill = lowQ)) +
    geom_bar(stat = "identity") +
    labs(
      title = paste("LowQ Percentage:", tma),
      x = "Core",
      y = "Percentage of Cells",
      fill = "Low-Quality"
    ) +
    theme_minimal(base_size = 14) +
    theme(
      axis.text.x = element_text(angle = 90, hjust = 1),
      legend.position = "top"
    )
  
  print(plot)
}


```

# Correlation Heatmap of cell counts

```{r include=FALSE}
seurat = readRDS("./TMA_unfiltered_annotated_full_final.rds")

```

```{r include=FALSE}
seurat_metadata <- seurat@meta.data
```

```{r echo=FALSE, fig.height=8, fig.width=10}
library(dplyr)
library(tidyr)
library(pheatmap)

generate_correlation_heatmaps <- function(seurat_metadata, annotation_level, output_dir = "./heatmaps/") {
  if (!annotation_level %in% colnames(seurat_metadata)) {
    stop(paste("Annotation level", annotation_level, "not found in metadata!"))
  }
  
  if (!dir.exists(output_dir)) {
    dir.create(output_dir, recursive = TRUE)
  }
  
  filtered_metadata <- seurat_metadata %>%
    filter(!get(annotation_level) %in% c("unclassified", "low_qual"))
  
  unique_tmas <- unique(filtered_metadata$orig.ident)
  
  for (tma in unique_tmas) {
    tma_data <- filtered_metadata %>%
      filter(orig.ident == tma) %>%
      group_by(tumor_core, !!sym(annotation_level)) %>%
      summarise(cell_count = n(), .groups = "drop") %>%
      pivot_wider(names_from = !!sym(annotation_level), values_from = cell_count, values_fill = 0)
    
    correlation_data <- tma_data %>%
      select(-tumor_core)
    
    correlation_matrix <- cor(correlation_data, use = "pairwise.complete.obs")
    
    heatmap_file <- paste0(output_dir, annotation_level, "_", tma, ".png")
    pheatmap(
      correlation_matrix,
      
      cluster_rows = TRUE,
      cluster_cols = TRUE,
      main = paste("Pairwise Correlations -", annotation_level, "-", tma),
      color = colorRampPalette(c("blue", "white", "red"))(100),
      border_color = NA,
      fontsize = 10,
      angle_col = 45,
      width = 10, 
      height = 8
    )
  }
}

output_dir <- "/home/czackl/export/merfish2/heatmap/"

generate_correlation_heatmaps(seurat_metadata = seurat@meta.data, annotation_level = "cell_type_level0", output_dir = output_dir)

generate_correlation_heatmaps(seurat_metadata = seurat@meta.data, annotation_level = "cell_type_level1", output_dir = output_dir)

```


# Scatter Plot LowQ vs total Annotated 
```{r echo=FALSE}
scatterplot_data <- metadata %>%
  group_by(orig.ident, tumor_core) %>%
  summarise(
    lowq_percentage = sum(lowQ, na.rm = TRUE) / n() * 100,
    total_annotated_cells = sum(!cell_type_level0 %in% c("low_qual", "unclassified"), na.rm = TRUE)
  ) %>%
  mutate(core_id = gsub("TMA[0-9]_", "", tumor_core)) # Remove the TMA1_, TMA2_, etc. prefix

unique_tmas <- unique(scatterplot_data$orig.ident)

for (tma in unique_tmas) {
  tma_data <- scatterplot_data %>%
    filter(orig.ident == tma)
  
  plot <- ggplot(tma_data, aes(x = total_annotated_cells, y = lowq_percentage)) +
    geom_point(alpha = 0.6, size = 3) +
    geom_text(aes(label = core_id), hjust = 1.1, vjust = 1.1, size = 3.5, check_overlap = TRUE) +
    labs(
      title = paste("LowQ Percentage vs Total Annotated Cells -", tma),
      x = "Total Annotated Cells",
      y = "Percentage of LowQ Cells"
    ) +
    theme_minimal(base_size = 14) +
    theme(
      plot.title = element_text(face = "bold")
    ) +
    geom_smooth(method = "lm", se = FALSE, color = "blue", linetype = "dashed")
  
  print(plot)
  
  ggsave(
    filename = paste0("scatterplot_lowq_vs_annotated_", tma, ".png"),
    plot = plot,
    width = 8,
    height = 6,
    bg = "white"
  )
}


```

